import sqlite3
from typing import Dict, Any, List, Optional
from datetime import datetime

class DatabaseError(Exception):
    """ุงุณุชุซูุงุก ูุฎุตุต ููุชุนุงูู ูุน ุฃุฎุทุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    def __init__(self, message: str):
        """
        ุชููุฆุฉ ุงุณุชุซูุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ุฑุณุงูุฉ ุฎุทุฃ.

        Args:
            message (str): ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูุชู ุชุตู ุงููุดููุฉ
        """
        super().__init__(message)

class DatabaseManager:
    def __init__(self, db_path: str = 'battleship.db'):
        """
        ุฏู ุฏุงูุฉ ุจุชุจุฏุฃ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุชุฌูุฒูุง ููุงุณุชุฎุฏุงู.
        
        ุงููุฏุฎูุงุช:
            db_path: ุฏู ูุณุงุฑ ุงูููู ุงููู ููุญุท ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                    ูู ููุชุจูุงุด ุญุงุฌุฉ ููุจูู ุงุณูู 'battleship.db'
        """
        # ููุญุงูู ูุนูู ุงูุฎุทูุงุช ุฏู
        try:
            # ุฃูู ุญุงุฌุฉ ูููุชุญ ุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
            self.conn = sqlite3.connect(db_path)
            
            # ููุดุบู ุฎุงุตูุฉ ุงูููุงุชูุญ ุงูุฎุงุฑุฌูุฉ ุนุดุงู ูุฑุจุท ุงูุฌุฏุงูู ุจุจุนุถ
            self.conn.execute("PRAGMA foreign_keys = ON")
            
            # ูููุดุฆ ุงูุฌุฏุงูู ุงููู ููุญุชุงุฌูุง
            self.create_tables()
            
        # ูู ุญุตู ุฃู ูุดููุฉ
        except sqlite3.Error as e:
            # ููุฑูู ุฑุณุงูุฉ ุฎุทุฃ ุชูุถุญ ุงููุดููุฉ
            raise DatabaseError(f"ููุฏุฑูุงุด ููุดุฆ ูุงุนุฏุฉ ุงูุจูุงูุงุช: {str(e)}")

    def execute_safe(self, query: str, params: tuple = ()) -> sqlite3.Cursor:
        """
        ุฏู ูุธููุฉ ุจุชููุฐ ุงุณุชุนูุงู SQL ุจุทุฑููุฉ ุขููุฉ ูุจุชุชุนุงูู ูุน ุงูุฃุฎุทุงุก ูู ุญุตูุช

        ุงููุฏุฎูุงุช:
            query: ุฏู ุงูุงุณุชุนูุงู ุงููู ุนุงูุฒูู ูููุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            params: ุฏู ุงูุจูุงูุงุช ุงููู ููุญุทูุง ูู ุงูุงุณุชุนูุงู (ุงุฎุชูุงุฑู)

        ุงููุฎุฑุฌุงุช:
            ุจุชุฑุฌุน ูุชูุฌุฉ ุชูููุฐ ุงูุงุณุชุนูุงู

        ุงูุฃุฎุทุงุก:
            ูู ุญุตู ูุดููุฉุ ูุชุฑูู DatabaseError ูุน ุฑุณุงูุฉ ุจุชูุถุญ ุงููุดููุฉ
        """
        # ููุญุงูู ูููุฐ ุงูุงุณุชุนูุงู
        try:
            # ููููุฐ ุงูุงุณุชุนูุงู ููุฑุฌุน ุงููุชูุฌุฉ
            result = self.conn.execute(query, params)
            return result
            
        # ูู ุญุตู ุฃู ูุดููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        except sqlite3.Error as e:
            # ููุฑูู ุฑุณุงูุฉ ุฎุทุฃ ุชูุถุญ ุงููุดููุฉ
            raise DatabaseError(f"ุฎุทุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: {str(e)}")

    def create_tables(self):
        """
        ุฏู ูุธููุฉ ุจุชุนูู ุงูุฌุฏุงูู ุงููู ููุญุชุงุฌูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        ูู ุงูุฌุฏุงูู ูุด ููุฌูุฏุฉุ ูุชุนูููุง
        ูู ููุฌูุฏุฉุ ูุด ูุชุนูู ุญุงุฌุฉ
        """
        try:
            # ูููุชุญ ุงุชุตุงู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
            with self.conn:
                # ููุนูู ุฌุฏูู ุงููุงุนุจูู
                # ุฏู ุฃูู ุฌุฏูู ุนูุฏูุง
                # ููู ูู ูุนูููุงุช ุงููุงุนุจ ุฒู:
                # - ุงูุงุณู ุจุชุงุนู
                # - ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจูุง
                # - ุนุฏุฏ ุงููุฑุงุช ุงููู ูุณุจ ูููุง
                # - ุนุฏุฏ ุงูุทููุงุช ุงููู ุถุฑุจูุง
                # - ุนุฏุฏ ุงููุฑุงุช ุงููู ุตุงุจ ูููุง
                # - ูุณุจุฉ ุงูุชุตููุจ ุจุชุงุนุชู
                # - ููุช ูุง ุนูู ุญุณุงุจ
                # - ุขุฎุฑ ูุฑุฉ ูุนุจ ูููุง
                self.conn.execute('''
                    CREATE TABLE IF NOT EXISTS players (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL UNIQUE,
                        games_played INTEGER DEFAULT 0,
                        games_won INTEGER DEFAULT 0,
                        total_shots INTEGER DEFAULT 0,
                        total_hits INTEGER DEFAULT 0,
                        accuracy REAL DEFAULT 0.0,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        last_played TIMESTAMP
                    )
                ''')
                
                # ููุนูู ุฌุฏูู ุฅุนุฏุงุฏุงุช ูู ูุงุนุจ
                # ุฒู ุญุฌู ุงูุดุจูุฉ ุงููู ุจููุนุจ ุนูููุง
                self.conn.execute('''
                    CREATE TABLE IF NOT EXISTS player_settings (
                        player_id INTEGER PRIMARY KEY,
                        grid_size INTEGER DEFAULT 10,
                        FOREIGN KEY (player_id) REFERENCES players (id)
                            ON DELETE CASCADE
                    )
                ''')
                
                # ููุนูู ุฌุฏูู ุชุงุฑูุฎ ุงููุนุจ
                # ุนุดุงู ูุญูุธ ููู ูู ูุนุจุฉ ุงููุงุนุจ ูุนุจูุง
                # ูุฅูู ุงููู ุญุตู ูููุง
                self.conn.execute('''
                    CREATE TABLE IF NOT EXISTS game_history (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        player_id INTEGER,
                        result TEXT NOT NULL,
                        grid_size INTEGER DEFAULT 10,
                        moves INTEGER,
                        hits INTEGER,
                        misses INTEGER,
                        accuracy REAL,
                        duration INTEGER,
                        played_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (player_id) REFERENCES players (id)
                            ON DELETE CASCADE
                    )
                ''')
                
                # ููุนูู ุฌุฏูู ุฅุญุตุงุฆูุงุช ุงูุณูู
                # ุนุดุงู ูุนุฑู ูู ุณูููุฉ ุญุตููุง ุฅูู ูู ูู ูุนุจุฉ
                self.conn.execute('''
                    CREATE TABLE IF NOT EXISTS ship_statistics (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        game_id INTEGER,
                        ship_name TEXT NOT NULL,
                        was_sunk BOOLEAN,
                        hits_taken INTEGER,
                        turns_to_sink INTEGER,
                        FOREIGN KEY (game_id) REFERENCES game_history (id)
                            ON DELETE CASCADE
                    )
                ''')
                
        # ูู ุญุตู ุฃู ูุดููุฉ
        except sqlite3.Error as e:
            # ููุทุจุน ุงูุฎุทุฃ ููุฑููู ููู ุงุณุชุฏุนู ุงููุธููุฉ
            print(f"ูู ูุดููุฉ ุญุตูุช ูุฅุญูุง ุจูุนูู ุงูุฌุฏุงูู: {e}")
            raise DatabaseError(f"ููุฏุฑูุงุด ูุนูู ุงูุฌุฏุงูู: {str(e)}")

    def create_player(self, name: str) -> int:
        """
        ุงููุธููุฉ ุฏู ุจุชุนูู ูุงุนุจ ุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุชุฑุฌุน ุฑููู.
        
        ุจุชุงุฎุฏ:
            name: ุงุณู ุงููุงุนุจ ุงููู ุนุงูุฒูู ูุถููู
            
        ุจุชุฑุฌุน:
            ุฑูู ุงููุงุนุจ ุงูุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            
        ูููู ุชุทูุน ุฃุฎุทุงุก:
            - ูู ุงูุงุณู ุฏู ููุฌูุฏ ูุจู ูุฏู
            - ูู ุญุตู ุฃู ูุดููุฉ ุชุงููุฉ
        """
        # ููุญุงูู ูุถูู ุงููุงุนุจ ุงูุฌุฏูุฏ
        try:
            # ูููุชุญ ุงุชุตุงู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
            with self.conn:
                # ููุทุจุน ุฑุณุงูุฉ ููุชุฃูุฏ
                print(f"ุฅูุดุงุก ูุงุนุจ ุฌุฏูุฏ ุจุงูุงุณู: {name}")
                
                # ููุดูู ุงููุณุงูุงุช ุงูุฒูุงุฏุฉ ูู ุงูุงุณู
                clean_name = name.strip()
                
                # ููุถูู ุงููุงุนุจ ูู ุงูุฌุฏูู
                # ูู ุงูุฃุฑูุงู ูุชุจุฏุฃ ุจุตูุฑ (ูุง ูุนุจุด ุฃู ูุนุจุฉ ูุณู)
                cursor = self.conn.execute('''
                    INSERT INTO players 
                    (name, games_played, games_won, total_shots, total_hits, accuracy) 
                    VALUES (?, 0, 0, 0, 0, 0.0)
                ''', (clean_name,))
                
                # ููุงุฎุฏ ุฑูู ุงููุงุนุจ ุงููู ุงุชุถุงู
                player_id = cursor.lastrowid
                
                # ููุทุจุน ุฑุณุงูุฉ ููุชุฃูุฏ
                print(f"ุชู ุฅูุดุงุก ุงููุงุนุจ ุจูุฌุงุญ ุจุงููุนุฑู: {player_id}")
                
                # ููุฑุฌุน ุฑูู ุงููุงุนุจ
                return player_id
                
        # ูู ุงูุงุณู ููุฌูุฏ ูุจู ูุฏู
        except sqlite3.IntegrityError:
            print("ุฎุทุฃ: ุงุณู ุงููุงุนุจ ููุฌูุฏ ุจุงููุนู")
            raise DatabaseError("ุงููุงุนุจ ููุฌูุฏ ุจุงููุนู")
            
        # ูู ูู ุฃู ูุดููุฉ ุชุงููุฉ
        except Exception as e:
            print(f"ุฎุทุฃ ูู ุฅูุดุงุก ุงููุงุนุจ: {e}")
            raise DatabaseError(f"ูุดู ูู ุฅูุดุงุก ุงููุงุนุจ: {str(e)}")

    def get_player(self, player_id: int) -> Optional[Dict]:
        """
        ุงููุธููุฉ ุฏู ุจุชุฌูุจ ูุนูููุงุช ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        ุจุชุงุฎุฏ:
            player_id: ุฑูู ุงููุงุนุจ ุงููู ุนุงูุฒูู ูุฌูุจ ูุนูููุงุชู
            
        ุจุชุฑุฌุน:
            ูุนูููุงุช ุงููุงุนุจ ูู ุดูู ูุงููุณุ ุฃู None ูู ูุด ููุฌูุฏ
        """
        # ููุญุงูู ูุฌูุจ ุจูุงูุงุช ุงููุงุนุจ
        try:
            # ููุณุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนู ุงููุงุนุจ ุฏู
            cursor = self.conn.execute(
                'SELECT * FROM players WHERE id = ?',
                (player_id,)
            )
            
            # ููุฌูุจ ุฃูู ุตู ูู ุงููุชูุฌุฉ
            ุจูุงูุงุช_ุงููุงุนุจ = cursor.fetchone()
            
            # ูู ููููุง ุงููุงุนุจ
            if ุจูุงูุงุช_ุงููุงุนุจ:
                # ููุฑุฌุน ูุนูููุงุชู ูู ูุงููุณ
                # ูู ูู ุฃู ูุนูููุฉ ูุด ููุฌูุฏุฉ ููุญุท ูููุฉ ุงูุชุฑุงุถูุฉ
                return {
                    'id': ุจูุงูุงุช_ุงููุงุนุจ[0],                    # ุฑูู ุงููุงุนุจ
                    'name': ุจูุงูุงุช_ุงููุงุนุจ[1],                  # ุงุณู ุงููุงุนุจ
                    'games_played': ุจูุงูุงุช_ุงููุงุนุจ[2] or 0,     # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจูุง
                    'games_won': ุจูุงูุงุช_ุงููุงุนุจ[3] or 0,        # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุณุจ ูููุง
                    'total_shots': ุจูุงูุงุช_ุงููุงุนุจ[4] or 0,      # ุนุฏุฏ ุงูุทููุงุช ุงูููู
                    'total_hits': ุจูุงูุงุช_ุงููุงุนุจ[5] or 0,       # ุนุฏุฏ ุงูุฅุตุงุจุงุช
                    'accuracy': ุจูุงูุงุช_ุงููุงุนุจ[6] or 0.0,       # ูุณุจุฉ ุงูุฏูุฉ
                    'created_at': ุจูุงูุงุช_ุงููุงุนุจ[7] or None,    # ููุช ุฅูุดุงุก ุงูุญุณุงุจ
                    'last_played': ุจูุงูุงุช_ุงููุงุนุจ[8] or None    # ุขุฎุฑ ูุฑุฉ ูุนุจ ูููุง
                }
            
            # ูู ูุด ููุฌูุฏ ููุฑุฌุน None
            return None
            
        # ูู ุญุตู ุฃู ูุดููุฉ
        except Exception as e:
            # ููุทุจุน ุฑุณุงูุฉ ุงูุฎุทุฃ
            print(f"ุฎุทุฃ ูู ุฌูุจ ุงููุงุนุจ: {e}")
            return None
            return None

    def save_game_result(self, player_id: int, result: Dict[str, Any]):
        """
        ุงููุธููุฉ ุฏู ุจุชุญูุธ ูุชูุฌุฉ ุงููุนุจุฉ ูุจุชุญุฏุซ ูุนูููุงุช ุงููุงุนุจ

        ุจุชุงุฎุฏ:
            player_id: ุฑูู ุงููุงุนุจ
            result: ูุนูููุงุช ูุชูุฌุฉ ุงููุนุจุฉ (ุนุฏุฏ ุงูุถุฑุจุงุชุ ุนุฏุฏ ุงูุฅุตุงุจุงุชุ ุฅูุฎ)

        ูู ุญุตู ูุดููุฉ ูุชุฑุฌุน ุฎุทุฃ
        """
        try:
            # ููุชุฃูุฏ ุงูุฃูู ุฅู ุงููุงุนุจ ููุฌูุฏ
            if not self.get_player(player_id):
                raise ValueError(f"ูููุด ูุงุนุจ ุจุฑูู {player_id}")
            
            # ููุญุณุจ ูุณุจุฉ ุงูุฏูุฉ (ูุงู ุฅุตุงุจุฉ ูู ูู ุงูุถุฑุจุงุช)
            if result['moves'] > 0:
                accuracy = (result['hits'] / result['moves']) * 100
            else:
                accuracy = 0
            
            # ููุญูุธ ูุชูุฌุฉ ุงููุนุจุฉ ูู ุฌุฏูู ุงูุชุงุฑูุฎ
            self.execute_safe('''
                INSERT INTO game_history 
                (player_id, result, grid_size, moves, hits, misses, accuracy, duration)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                player_id,                  # ุฑูู ุงููุงุนุจ
                result['outcome'],          # ูุชูุฌุฉ ุงููุนุจุฉ (ููุฒ ุฃู ุฎุณุงุฑุฉ)
                result.get('grid_size', 10),# ุญุฌู ุงูุดุจูุฉ
                result['moves'],            # ุนุฏุฏ ุงูุถุฑุจุงุช
                result['hits'],             # ุนุฏุฏ ุงูุฅุตุงุจุงุช
                result['misses'],           # ุนุฏุฏ ุงููุญุงููุงุช ุงููุงุดูุฉ
                accuracy,                   # ูุณุจุฉ ุงูุฏูุฉ
                result['duration']          # ูุฏุฉ ุงููุนุจุฉ
            ))
            
            # ููุญุฏุซ ูุนูููุงุช ุงููุงุนุจ
            self.execute_safe('''
                UPDATE players 
                SET games_played = games_played + 1,
                    games_won = games_won + CASE WHEN ? = 'win' THEN 1 ELSE 0 END,
                    total_shots = total_shots + ?,
                    total_hits = total_hits + ?,
                    accuracy = (total_hits * 100.0 / NULLIF(total_shots, 0)),
                    last_played = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (
                result['outcome'],  # ูุชูุฌุฉ ุงููุนุจุฉ
                result['moves'],    # ุนุฏุฏ ุงูุถุฑุจุงุช
                result['hits'],     # ุนุฏุฏ ุงูุฅุตุงุจุงุช
                player_id          # ุฑูู ุงููุงุนุจ
            ))
                
        except Exception as e:
            # ูู ุญุตู ุฃู ูุดููุฉ ููุทุจุน ุฑุณุงูุฉ ุงูุฎุทุฃ
            print(f"ูู ูุดููุฉ ุญุตูุช ูุฃูุง ุจุญูุธ ูุชูุฌุฉ ุงููุนุจุฉ: {e}")
            raise

    def get_player_statistics(self, player_id: int) -> Dict[str, Any]:
        """
        ุจุชุฌูุจ ูุนูููุงุช ูุฅุญุตุงุฆูุงุช ุนู ุงููุงุนุจ

        Args:
            player_id: ุฑูู ุงููุงุนุจ ุงููู ุนุงูุฒูู ูุฌูุจ ูุนูููุงุชู

        Returns:
            ูุงููุณ ููู ูู ุงููุนูููุงุช ูุงูุฅุญุตุงุฆูุงุช ุจุชุงุนุช ุงููุงุนุจ
        """
        try:
            # ููุฌูุจ ุงููุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            cursor = self.conn.execute('''
                SELECT 
                    p.games_played,
                    p.games_won,
                    p.total_shots,
                    p.total_hits,
                    p.accuracy,
                    MIN(g.moves) as best_game,
                    MAX(g.moves) as worst_game,
                    AVG(g.duration) as avg_duration,
                    COUNT(CASE WHEN g.result = 'win' AND g.moves <= 30 THEN 1 END) as quick_wins,
                    ROUND(CAST(p.games_won AS FLOAT) / NULLIF(p.games_played, 0) * 100, 2) as win_rate,
                    ROUND(AVG(g.accuracy), 2) as accuracy_rate
                FROM players p
                LEFT JOIN game_history g ON p.id = g.player_id
                WHERE p.id = ?
                GROUP BY p.id
            ''', (player_id,))
            
            # ููุฌูุจ ุงููุชูุฌุฉ
            row = cursor.fetchone()
            
            # ูู ููููุง ูุนูููุงุช ููุฑุฌุนูุง
            if row:
                return {
                    'games_played': row[0],     # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจ ูููุง
                    'games_won': row[1],        # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุณุจ ูููุง
                    'total_shots': row[2],      # ุนุฏุฏ ุงูุถุฑุจุงุช ุงูููู
                    'total_hits': row[3],       # ุนุฏุฏ ุงูุฅุตุงุจุงุช ุงูููู
                    'accuracy': row[4],         # ูุณุจุฉ ุงูุชุตููุจ
                    'best_game': row[5],        # ุฃูุถู ูุนุจุฉ (ุฃูู ุนุฏุฏ ุถุฑุจุงุช)
                    'worst_game': row[6],       # ุฃุณูุฃ ูุนุจุฉ (ุฃูุจุฑ ุนุฏุฏ ุถุฑุจุงุช)
                    'avg_duration': row[7],     # ูุชูุณุท ููุช ุงููุนุจ
                    'quick_wins': row[8],       # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุณุจ ูููุง ุจุณุฑุนุฉ
                    'win_rate': row[9],         # ูุณุจุฉ ุงูููุฒ
                    'accuracy_rate': row[10]    # ูุชูุณุท ูุณุจุฉ ุงูุชุตููุจ
                }
            
            # ูู ูููุด ูุนูููุงุช ููุฑุฌุน ูุงููุณ ูุงุถู
            return {}
            
        except Exception as e:
            # ูู ูู ูุดููุฉ ููุทุจุน ุงูุฎุทุฃ ููุฑุฌุน ูุงููุณ ูุงุถู
            print(f"ูู ูุดููุฉ ุญุตูุช ูุฃูุง ุจุฌูุจ ูุนูููุงุช ุงููุงุนุจ: {e}")
            return {}

    def get_game_history(self, player_id: int, limit: int = 10) -> List[Dict]:
        """
        ุงูุฏุงูุฉ ุฏู ุจุชุฌูุจ ุชุงุฑูุฎ ุขุฎุฑ ูุงู ูุนุจุฉ ุงููุงุนุจ ูุนุจูุง
        
        ุจุชุงุฎุฏ:
            - ุฑูู ุงููุงุนุจ (player_id)
            - ุนุฏุฏ ุงูุฃูุนุงุจ ุงููู ุนุงูุฒ ุชุฌูุจูุง (limit) - ูู ููุชุจุชุด ุญุงุฌุฉ ูุชุฌูุจ ุขุฎุฑ 10 ุฃูุนุงุจ
            
        ุจุชุฑุฌุน:
            - ูุงููุฉ ูููุง ูุนูููุงุช ุนู ูู ูุนุจุฉ (ุฒู ุงููุชูุฌุฉ ูุนุฏุฏ ุงูุญุฑูุงุช ูุงูุชุงุฑูุฎ)
        """
        try:
            # ููุฌูุจ ุงูุจูุงูุงุช ูู ุฌุฏูู ุชุงุฑูุฎ ุงูุฃูุนุงุจ
            cursor = self.conn.execute('''
                SELECT * FROM game_history 
                WHERE player_id = ?
                ORDER BY played_at DESC
                LIMIT ?
            ''', (player_id, limit))
            
            # ููุฌูุจ ูู ุงูุตููู ุงููู ููููุงูุง
            all_games = cursor.fetchall()
            
            # ููุนูู ูุงููุฉ ูุงุถูุฉ ูุญุท ูููุง ูุนูููุงุช ูู ูุนุจุฉ
            games_list = []
            
            # ูููู ุนูู ูู ูุนุจุฉ ููุฌูุฒ ูุนูููุงุชูุง
            for row in all_games:
                game_info = {
                    'id': row[0],               # ุฑูู ุงููุนุจุฉ
                    'result': row[2],           # ูุชูุฌุฉ ุงููุนุจุฉ (ููุฒ ููุง ุฎุณุงุฑุฉ)
                    'grid_size': row[3],        # ุญุฌู ุงูุดุจูุฉ
                    'moves': row[4],            # ุนุฏุฏ ุงูุญุฑูุงุช
                    'hits': row[5],             # ุนุฏุฏ ุงููุฑุงุช ุงููู ุถุฑุจ ูููุง ุตุญ
                    'misses': row[6],           # ุนุฏุฏ ุงููุฑุงุช ุงููู ุถุฑุจ ูููุง ุบูุท
                    'accuracy': row[7],         # ูุณุจุฉ ุงูุชุตููุจ
                    'duration': row[8],         # ูุฏุฉ ุงููุนุจุฉ
                    'played_at': row[10]        # ุชุงุฑูุฎ ุงููุนุจ
                }
                # ููุถูู ูุนูููุงุช ุงููุนุจุฉ ูููุงููุฉ
                games_list.append(game_info)
            
            return games_list
            
        except Exception as e:
            # ูู ูู ูุดููุฉ ุญุตูุช ููุทุจุน ุงูุฎุทุฃ ููุฑุฌุน ูุงููุฉ ูุงุถูุฉ
            print(f"ูู ูุดููุฉ ุญุตูุช ูุฃูุง ุจุฌูุจ ุชุงุฑูุฎ ุงูุฃูุนุงุจ: {e}")
            return []

    def close(self):
        """
        ุงูุฏุงูุฉ ุฏู ุจุชููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
        ูุงุฒู ูุณุชุฎุฏููุง ููุง ูุฎูุต ุดุบู ุนุดุงู ูุญุงูุธ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        ูููุงู ุนุดุงู ููุถูุนุด ููุงุฑุฏ ุงูููุจููุชุฑ
        
        ูุซุงู ููุงุณุชุฎุฏุงู:
        db = DatabaseManager()
        # ูุนูู ุดุบููุง ููุง
        db.close()  # ูููู ุงูุงุชุตุงู ููุง ูุฎูุต
        """
        # ููุง ุจูููู ููุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุง ุฎูุตูุง ุดุบู ูุนุงูุฒูู ูููู ุงูุงุชุตุงู
        self.conn.close()

    def get_leaderboard(self, limit: int = 10, time_period: str = 'all') -> List[Dict]:
        """
        ุจุชุฌูุจ ูุงุฆูุฉ ุฃุญุณู ุงููุงุนุจูู ูู ุงููุนุจุฉ.
        
        ุงููุฏุฎูุงุช:
            limit: ุนุฏุฏ ุงููุงุนุจูู ุงููู ุนุงูุฒูู ูุฌูุจูู (ุงูุชุฑุงุถูุงู 10)
            time_period: ุงููุชุฑุฉ ุงูุฒูููุฉ ('all' ููู ุงูููุชุ 'week' ูุขุฎุฑ ุฃุณุจูุนุ 'month' ูุขุฎุฑ ุดูุฑุ 'year' ูุขุฎุฑ ุณูุฉ)
        
        ุงููุฎุฑุฌุงุช:
            ูุงุฆูุฉ ูููุง ูุนูููุงุช ูู ูุงุนุจ (ุงุณููุ ุนุฏุฏ ูุฑุงุช ุงููุนุจุ ุนุฏุฏ ูุฑุงุช ุงูููุฒุ ุฅูุฎ)
        """
        try:
            # ููุญุฏุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ ุงููู ููุฌูุจ ูููุง ุงููุชุงุฆุฌ
            time_filter = ''
            if time_period == 'week':
                time_filter = "AND g.played_at >= date('now', '-7 days')"  # ุขุฎุฑ 7 ุฃูุงู
            elif time_period == 'month':
                time_filter = "AND g.played_at >= date('now', '-1 month')"  # ุขุฎุฑ ุดูุฑ
            elif time_period == 'year':
                time_filter = "AND g.played_at >= date('now', '-1 year')"  # ุขุฎุฑ ุณูุฉ

            # ููุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            cursor = self.conn.execute(f'''
                WITH PlayerStats AS (
                    SELECT 
                        p.name,                                                    -- ุงุณู ุงููุงุนุจ
                        COUNT(DISTINCT g.id) as games_played,                      -- ุนุฏุฏ ูุฑุงุช ุงููุนุจ
                        SUM(CASE WHEN g.result = 'win' THEN 1 ELSE 0 END) as games_won,  -- ุนุฏุฏ ูุฑุงุช ุงูููุฒ
                        AVG(g.accuracy) as avg_accuracy,                           -- ูุชูุณุท ุงูุฏูุฉ
                        MIN(g.moves) as best_game,                                -- ุฃูุถู ูุนุจุฉ (ุฃูู ุนุฏุฏ ุญุฑูุงุช)
                        COUNT(DISTINCT CASE WHEN g.result = 'win' AND g.moves <= 30 
                            THEN g.id END) as quick_wins                          -- ุนุฏุฏ ูุฑุงุช ุงูููุฒ ุงูุณุฑูุน
                    FROM players p
                    LEFT JOIN game_history g ON p.id = g.player_id
                    WHERE 1=1 {time_filter}
                    GROUP BY p.id, p.name
                    HAVING games_played > 0
                )
                SELECT 
                    name,
                    games_played,
                    games_won,
                    ROUND(CAST(games_won AS FLOAT) / games_played * 100, 2) as win_ratio,  -- ูุณุจุฉ ุงูููุฒ
                    ROUND(avg_accuracy, 2) as accuracy,                                     -- ุงูุฏูุฉ
                    best_game,
                    quick_wins,
                    ROUND(CAST(quick_wins AS FLOAT) / games_won * 100, 2) as quick_win_ratio  -- ูุณุจุฉ ุงูููุฒ ุงูุณุฑูุน
                FROM PlayerStats
                ORDER BY win_ratio DESC, accuracy DESC
                LIMIT ?
            ''', (limit,))
            
            # ููุญูู ุงููุชุงุฆุฌ ููุงุฆูุฉ ูู ุงูููุงููุณ ุนุดุงู ุชููู ุฃุณูู ูู ุงูุงุณุชุฎุฏุงู
            results = []
            for row in cursor.fetchall():
                player_info = {
                    'name': row[0],             # ุงุณู ุงููุงุนุจ
                    'games_played': row[1],     # ุนุฏุฏ ูุฑุงุช ุงููุนุจ
                    'games_won': row[2],        # ุนุฏุฏ ูุฑุงุช ุงูููุฒ
                    'win_ratio': row[3],        # ูุณุจุฉ ุงูููุฒ
                    'accuracy': row[4],         # ุงูุฏูุฉ
                    'best_game': row[5],        # ุฃูุถู ูุนุจุฉ
                    'quick_wins': row[6],       # ุนุฏุฏ ูุฑุงุช ุงูููุฒ ุงูุณุฑูุน
                    'quick_win_ratio': row[7]   # ูุณุจุฉ ุงูููุฒ ุงูุณุฑูุน
                }
                results.append(player_info)
            
            return results

        except Exception as e:
            # ูู ูู ูุดููุฉ ุญุตูุช ููุทุจุน ุงูุฎุทุฃ ููุฑุฌุน ูุงุฆูุฉ ูุงุถูุฉ
            print(f"ูู ูุดููุฉ ุญุตูุช ูุฃูุง ุจุฌูุจ ูุงุฆูุฉ ุงููุชุตุฏุฑูู: {e}")
            return []

    def get_ship_statistics(self, player_id: int) -> Dict[str, Any]:
        """
        ุงูุฏุงูุฉ ุฏู ุจุชุฌูุจ ูุนูููุงุช ุนู ุฃุฏุงุก ุงูุณูู ุจุชุงุนุฉ ุงููุงุนุจ ูู ูู ุงููุนุงุฑู ุงููู ูุนุจูุง
        
        ุจุชุงุฎุฏ:
            player_id: ุฑูู ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        ุจุชุฑุฌุน:
            ูุนูููุงุช ุนู ูู ุณูููุฉ ุฒู:
            - ุนุฏุฏ ุงููุนุงุฑู ุงููู ุดุงุฑูุช ูููุง
            - ุนุฏุฏ ุงููุฑุงุช ุงููู ุบุฑูุช ูููุง
            - ูุชูุณุท ุนุฏุฏ ุงูุถุฑุจุงุช ุงููู ุฃููุชูุง
            - ูุชูุณุท ุนุฏุฏ ุงูุฃุฏูุงุฑ ุงููู ุงุณุชุบุฑูุชูุง ุนุดุงู ุชุบุฑู
        """
        # ููุฌูุฒ ุงุณุชุนูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        cursor = self.conn.execute('''
            SELECT 
                sh.ship_name,                   -- ุงุณู ุงูุณูููุฉ
                COUNT(*) as total_battles,      -- ุนุฏุฏ ุงููุนุงุฑู
                -- ุนุฏุฏ ูุฑุงุช ุงูุบุฑู
                SUM(CASE WHEN sh.was_sunk THEN 1 ELSE 0 END) as times_sunk,
                AVG(sh.hits_taken) as avg_hits_taken,        -- ูุชูุณุท ุงูุถุฑุจุงุช
                AVG(sh.turns_to_sink) as avg_turns_to_sink   -- ูุชูุณุท ุฃุฏูุงุฑ ุงูุบุฑู
            FROM ship_statistics sh
            JOIN game_history gh ON sh.game_id = gh.id
            WHERE gh.player_id = ?
            GROUP BY sh.ship_name
        ''', (player_id,))
        
        # ููุญูู ุงููุชุงุฆุฌ ูุดูู ุณูู ูุชุนุงูู ูุนุงู
        ship_stats = {}
        for row in cursor.fetchall():
            ship_name = row[0]
            ship_stats[ship_name] = {
                'total_battles': row[1],      # ูู ุงููุนุงุฑู
                'times_sunk': row[2],         # ูุฑุงุช ุงูุบุฑู
                'avg_hits_taken': row[3],     # ูุชูุณุท ุงูุถุฑุจุงุช
                'avg_turns_to_sink': row[4]   # ูุชูุณุท ุงูุฃุฏูุงุฑ ููุบุฑู
            }
        
        return ship_stats

    def save_game_settings(self, player_id: int, settings: Dict[str, Any]):
        """
        ุงูุฏุงูุฉ ุฏู ุจุชุญูุธ ุฅุนุฏุงุฏุงุช ุงููุนุจุฉ ุจุชุงุนุฉ ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        ุจุชุงุฎุฏ:
            player_id: ุฑูู ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            settings: ูุงููุณ ููู ุงูุฅุนุฏุงุฏุงุช ุงููู ุนุงูุฒูู ูุญูุธูุง:
                     - ุญุฌู ุงูุดุจูุฉ (grid_size)
                     - ุงูุตูุช ุดุบุงู ููุง ูุง (sound_enabled) 
                     - ุงูููุณููู ุดุบุงูุฉ ููุง ูุง (music_enabled)
        
        ูุซุงู ููุฅุนุฏุงุฏุงุช:
        {
            'grid_size': 10,      # ุญุฌู ุงูุดุจูุฉ 10ร10
            'sound_enabled': True, # ุงูุตูุช ุดุบุงู
            'music_enabled': True  # ุงูููุณููู ุดุบุงูุฉ
        }
        """
        # ููุฌูุจ ุงูุฅุนุฏุงุฏุงุช ูู ุงููุงููุณุ ููู ูุด ููุฌูุฏุฉ ููุงุฎุฏ ุงูููู ุงูุงูุชุฑุงุถูุฉ
        grid_size = settings.get('grid_size', 10)         # ูู ูุด ููุฌูุฏุฉ ูุชููู 10
        sound_on = settings.get('sound_enabled', True)    # ูู ูุด ููุฌูุฏุฉ ูุชููู True
        music_on = settings.get('music_enabled', True)    # ูู ูุด ููุฌูุฏุฉ ูุชููู True
        
        # ููุญูุธ ุงูุฅุนุฏุงุฏุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        # ูู ุงูุฅุนุฏุงุฏุงุช ููุฌูุฏุฉ ูุจู ูุฏู ููุชู ุชุญุฏูุซูุง
        # ูู ูุด ููุฌูุฏุฉ ููุชู ุฅุถุงูุชูุง ุฌุฏูุฏ
        with self.conn:
            self.conn.execute('''
                INSERT OR REPLACE INTO player_settings 
                (player_id, grid_size, sound_enabled, music_enabled)
                VALUES (?, ?, ?, ?)
            ''', (player_id, grid_size, sound_on, music_on))

    def get_game_settings(self, player_id: int) -> Dict[str, Any]:
        """
        ุงูุฏุงูุฉ ุฏู ุจุชุฌูุจ ุฅุนุฏุงุฏุงุช ุงููุนุจุฉ ุจุชุงุนุฉ ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        ุจุชุงุฎุฏ:
            player_id: ุฑูู ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        ุจุชุฑุฌุน:
            ูุงููุณ ููู ุงูุฅุนุฏุงุฏุงุช ุฏู:
            - ุญุฌู ุงูุดุจูุฉ (grid_size) 
            - ุงูุตูุช ุดุบุงู ููุง ูุง (sound_enabled)
            - ุงูููุณููู ุดุบุงูุฉ ููุง ูุง (music_enabled)
        """
        # ููุฌูุจ ุฅุนุฏุงุฏุงุช ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        cursor = self.conn.execute('''
            SELECT grid_size, sound_enabled, music_enabled
            FROM player_settings
            WHERE player_id = ?
        ''', (player_id,))
        
        # ููุดูู ูู ููููุง ุฅุนุฏุงุฏุงุช ููุงุนุจ ุฏู
        settings_from_db = cursor.fetchone()
        
        # ูู ููููุง ุฅุนุฏุงุฏุงุชุ ููุฑุฌุนูุง
        if settings_from_db:
            game_settings = {
                'grid_size': settings_from_db[0],  # ุญุฌู ุงูุดุจูุฉ
                'sound_enabled': bool(settings_from_db[1]),  # ุงูุตูุช ุดุบุงู ููุง ูุง 
                'music_enabled': bool(settings_from_db[2])   # ุงูููุณููู ุดุบุงูุฉ ููุง ูุง
            }
            return game_settings
            
        # ูู ูููุด ุฅุนุฏุงุฏุงุชุ ููุฑุฌุน ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
        default_settings = {
            'grid_size': 10,       # ุญุฌู ุงูุดุจูุฉ ุงูุงูุชุฑุงุถู 10ร10
            'sound_enabled': True,  # ุงูุตูุช ุดุบุงู ุงูุชุฑุงุถูุงู
            'music_enabled': True   # ุงูููุณููู ุดุบุงูุฉ ุงูุชุฑุงุถูุงู
        }
        return default_settings

    def delete_player_data(self, player_id: int):
        """
        ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุชุนููุฉ ุจุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

        Args:
            player_id (int): ูุนุฑู ุงููุงุนุจ.
        """
        with self.conn:
            # ุญุฐู ูู ุฅุญุตุงุฆูุงุช ุงูุณูู ุนุจุฑ ุชุงุฑูุฎ ุงููุนุจ
            self.conn.execute('''
                DELETE FROM ship_statistics 
                WHERE game_id IN (
                    SELECT id FROM game_history WHERE player_id = ?
                )
            ''', (player_id,))
            
            # ุญุฐู ูู ุชุงุฑูุฎ ุงููุนุจ
            self.conn.execute('''
                DELETE FROM game_history 
                WHERE player_id = ?
            ''', (player_id,))
            
            # ุญุฐู ูู ุฅุนุฏุงุฏุงุช ุงููุงุนุจูู
            self.conn.execute('''
                DELETE FROM player_settings 
                WHERE player_id = ?
            ''', (player_id,))
            
            # ุญุฐู ูู ุฌุฏูู ุงููุงุนุจูู
            self.conn.execute('''
                DELETE FROM players 
                WHERE id = ?
            ''', (player_id,))

    def check_connection(self) -> bool:
        """
        ุงููุธููุฉ ุฏู ุจุชุชุฃูุฏ ุฅู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุดุบุงูุฉ ููุง ูุฃ
        ุจุชุนูู ูุฏู ุนู ุทุฑูู ุฅููุง ุจุชุญุงูู ุชููุฐ ุฃูุฑ ุจุณูุท ุฌุฏุงู
        ูู ูุฌุญ ุงูุฃูุฑ ูุจูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุดุบุงูุฉ
        ูู ูุดู ูุจูู ูู ูุดููุฉ ูู ุงูุงุชุตุงู

        Returns:
            bool: ุจุชุฑุฌุน True ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุดุบุงูุฉุ False ูู ูุด ุดุบุงูุฉ
        """
        # ููุญุงูู ูููุฐ ุฃูุฑ ุจุณูุท ุฌุฏุงู (ุงุฎุชูุงุฑ ุงูุฑูู 1)
        try:
            # ูู ุงูุฃูุฑ ุฏู ูุฌุญ ูุจูู ุงูุงุชุตุงู ุดุบุงู
            self.conn.execute("SELECT 1")
            # ููุฑุฌุน True
            return True
            
        # ูู ุญุตู ุฃู ูุดููุฉ ูู ุชูููุฐ ุงูุฃูุฑ
        except sqlite3.Error:
            # ูุจูู ูู ูุดููุฉ ูู ุงูุงุชุตุงู ููุฑุฌุน False
            return False

    def reconnect(self):
        """
        ุงููุธููุฉ ุฏู ุจุชุญุงูู ุชุนูุฏ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุงูุงุชุตุงู ุงุชูุทุน
        
        ุฎุทูุงุช ุงููุธููุฉ:
        1. ุจุชุชุฃูุฏ ุงูุฃูู ุฅู ุงูุงุชุตุงู ููุทูุน ูุนูุงู
        2. ูู ููุทูุนุ ุจุชุญุงูู ุชูุตู ุชุงูู
        3. ูู ูุญุงููุฉ ุงูุงุชุตุงู ูุดูุชุ ุจุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ
        """
        # ููุฌุฑุจ ูุนูู ุงูุฎุทูุงุช ุฏู
        try:
            # ูุดูู ุงูุฃูู - ุงูุงุชุตุงู ุดุบุงู ููุง ูุฃุ
            ุงุชุตุงู_ุดุบุงู = self.check_connection()
            
            # ูู ุงูุงุชุตุงู ูุด ุดุบุงู
            if not ุงุชุตุงู_ุดุบุงู:
                # ูุญุงูู ูุชุตู ุชุงูู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
                self.conn = sqlite3.connect('battleship.db')
                # ูุดุบู ุฎุงุตูุฉ ุงูู foreign keys
                self.conn.execute("PRAGMA foreign_keys = ON")
                
        # ูู ุญุตู ุฃู ูุดููุฉ ูู ุงูุงุชุตุงู
        except sqlite3.Error as e:
            # ูุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
            raise DatabaseError(f"ุชุนุฐุฑ ุฅุนุงุฏุฉ ุงูุงุชุตุงู: {str(e)}")

    def backup_database(self, backup_path: str):
        """
        ุงููุธููุฉ ุฏู ุจุชุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุชุญูุธูุง ูู ููุงู ุชุงูู
        ุนุดุงู ูู ุญุตู ุฃู ูุดููุฉ ููุฏุฑ ูุฑุฌุน ุงูุจูุงูุงุช ุชุงูู

        ุงููุฏุฎูุงุช:
            backup_path: ุงูููุงู ุงููู ุนุงูุฒูู ูุญูุธ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
            ูุซุงู: "C:/backups/my_backup.db"

        ูู ุญุตู ูุดููุฉ:
            ูุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ ุชูุถุญ ุฅูู ุงููุดููุฉ ุงููู ุญุตูุช
        """
        # ููุญุงูู ูุนูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
        try:
            # ูููุชุญ ููู ุฌุฏูุฏ ุนุดุงู ูุญุท ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
            ููู_ุงููุณุฎุฉ = sqlite3.connect(backup_path)
            
            # ูููุณุฎ ูู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููููู ุงูุฌุฏูุฏ
            with ููู_ุงููุณุฎุฉ:
                self.conn.backup(ููู_ุงููุณุฎุฉ)
            
            # ูููู ุงูููู ุจุนุฏ ูุง ูุฎูุต
            ููู_ุงููุณุฎุฉ.close()
            
        # ูู ุญุตูุช ุฃู ูุดููุฉ
        except sqlite3.Error as ุงููุดููุฉ:
            # ูููู ูููุณุชุฎุฏู ุฅู ูู ูุดููุฉ ุญุตูุช
            raise DatabaseError(f"ููุฏุฑูุงุด ูุนูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: {str(ุงููุดููุฉ)}")

    def find_player_by_name(self, name: str) -> Optional[Dict]:
        """
        ุงููุธููุฉ ุฏู ุจุชุฏูุฑ ุนูู ูุงุนุจ ูุนูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนู ุทุฑูู ุงุณูู.
        ุจุชุงุฎุฏ ุงุณู ุงููุงุนุจ ูุจุชุฏูุฑ ุนููู ูุจุชุฑุฌุน ูู ุงููุนูููุงุช ุจุชุงุนุชู.
        
        ูู ููุช ุงููุงุนุจ ูุชุฑุฌุน ูุนูููุงุชู ูุงููุฉ.
        ูู ูููุชูุด ูุชุฑุฌุน None ูุนูู ูููุด ุญุงุฌุฉ.
        """
        # ููุญุงูู ูุนูู ุงูุจุญุซ ููุดูู ูููุงูู ุงููุงุนุจ ููุง ูุฃ
        try:
            # ูููุธู ุงูุงุณู ูู ุงููุณุงูุงุช ุงูุฒูุงุฏุฉ ูู ุงูุฃูู ูุงูุขุฎุฑ
            ุงุณู_ูุธูู = name.strip()
            
            # ููุฏูุฑ ุนูู ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            # ูุด ูููุฑู ุจูู ุงูุญุฑูู ุงููุจูุฑุฉ ูุงูุตุบูุฑุฉ
            ูุชูุฌุฉ_ุงูุจุญุซ = self.conn.execute(
                'SELECT * FROM players WHERE LOWER(name) = LOWER(?)', 
                (ุงุณู_ูุธูู,)
            )
            
            # ููุฌูุจ ุฃูู ูุชูุฌุฉ ููููุงูุง
            ุจูุงูุงุช_ุงููุงุนุจ = ูุชูุฌุฉ_ุงูุจุญุซ.fetchone()
            
            # ูู ููููุง ุงููุงุนุจ
            if ุจูุงูุงุช_ุงููุงุนุจ:
                # ููุฑุฌุน ูู ุงููุนูููุงุช ุจุชุงุนุชู ูู ูุงููุณ
                return {
                    'id': ุจูุงูุงุช_ุงููุงุนุจ[0],  # ุงูุฑูู ุงูุชุนุฑููู
                    'name': ุจูุงูุงุช_ุงููุงุนุจ[1],  # ุงูุงุณู
                    'games_played': ุจูุงูุงุช_ุงููุงุนุจ[2] if ุจูุงูุงุช_ุงููุงุนุจ[2] is not None else 0,  # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจูุง
                    'games_won': ุจูุงูุงุช_ุงููุงุนุจ[3] if ุจูุงูุงุช_ุงููุงุนุจ[3] is not None else 0,  # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุณุจ ูููุง
                    'total_shots': ุจูุงูุงุช_ุงููุงุนุจ[4] if ุจูุงูุงุช_ุงููุงุนุจ[4] is not None else 0,  # ุนุฏุฏ ุงูุทููุงุช ุงูููู
                    'total_hits': ุจูุงูุงุช_ุงููุงุนุจ[5] if ุจูุงูุงุช_ุงููุงุนุจ[5] is not None else 0,  # ุนุฏุฏ ุงูุฅุตุงุจุงุช
                    'accuracy': ุจูุงูุงุช_ุงููุงุนุจ[6] if ุจูุงูุงุช_ุงููุงุนุจ[6] is not None else 0.0,  # ูุณุจุฉ ุงูุฏูุฉ
                    'created_at': ุจูุงูุงุช_ุงููุงุนุจ[7],  # ุชุงุฑูุฎ ุฅูุดุงุก ุงูุญุณุงุจ
                    'last_played': ุจูุงูุงุช_ุงููุงุนุจ[8]  # ุขุฎุฑ ูุฑุฉ ูุนุจ ูููุง
                }
            
            # ูู ูููููุงุด ุงููุงุนุจ
            return None
            
        # ูู ุญุตู ุฃู ูุดููุฉ ูู ุงูุจุญุซ
        except Exception as ุงููุดููุฉ:
            # ููุทุจุน ุงููุดููุฉ ููุฑุฌุน None
            print(f"ุฎุทุฃ ูู ุงูุจุญุซ ุนู ุงููุงุนุจ ุจุงูุงุณู: {ุงููุดููุฉ}")
            return None

    def get_player_achievements(self, player_id: int) -> List[Dict]:
        """
        ุจุชุฌูุจ ุฅูุฌุงุฒุงุช ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        ุจุชุงุฎุฏ:
            player_id: ุฑูู ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            
        ุจุชุฑุฌุน:
            ูุงุฆูุฉ ูููุง ูู ุงูุฅูุฌุงุฒุงุช ุงููู ุญูููุง ุงููุงุนุจ
        """
        # ูุงุฆูุฉ ูุงุถูุฉ ูุญุท ูููุง ุงูุฅูุฌุงุฒุงุช
        achievements = []
        
        try:
            # ูุฌูุจ ุฅุญุตุงุฆูุงุช ุงููุงุนุจ ุงูุฃูู
            stats = self.get_player_statistics(player_id)
            
            # ูุดูู ูู ุงููุงุนุจ ูุนุจ ูุชูุฑ
            if stats['games_played'] >= 100:
                # ูุถูู ุฅูุฌุงุฒ ุงููุนุจ ุงููุชูุฑ
                achievements.append({
                    'title': 'ูุงุนุจ ูุฎุถุฑู',
                    'description': 'ูุนุจ 100 ูุนุจุฉ ุฃู ุฃูุซุฑ',
                    'icon': '๐ฎ'
                })
            
            # ูุดูู ูู ุงููุงุนุจ ุจููุณุจ ูุชูุฑ
            if stats['win_rate'] >= 75:
                # ูุถูู ุฅูุฌุงุฒ ุงูููุฒ ุงููุชูุฑ
                achievements.append({
                    'title': 'ูุงุฆุฏ ูุญุชุฑู', 
                    'description': 'ุญุงูุธ ุนูู ูุณุจุฉ ููุฒ 75% ุฃู ุฃูุซุฑ',
                    'icon': '๐'
                })
            
            # ูุดูู ูู ุงููุงุนุจ ุจูุตูุจ ูุชูุฑ
            if stats['accuracy_rate'] >= 50:
                # ูุถูู ุฅูุฌุงุฒ ุงูุฏูุฉ ุงูุนุงููุฉ
                achievements.append({
                    'title': 'ุฑุงูู ุฏููู',
                    'description': 'ุญุงูุธ ุนูู ุฏูุฉ 50% ุฃู ุฃูุซุฑ', 
                    'icon': '๐ฏ'
                })
            
            # ูุดูู ูู ุงููุงุนุจ ุจููุณุจ ุจุณุฑุนุฉ
            if stats['quick_wins'] >= 10:
                # ูุถูู ุฅูุฌุงุฒ ุงูููุฒ ุงูุณุฑูุน
                achievements.append({
                    'title': 'ููุฒ ุณุฑูุน',
                    'description': 'ุญูู 10 ุงูุชุตุงุฑุงุช ุฃู ุฃูุซุฑ ูู ุฃูู ูู 30 ุญุฑูุฉ',
                    'icon': 'โก'
                })
            
            # ูุฑุฌุน ูู ุงูุฅูุฌุงุฒุงุช
            return achievements
            
        except Exception as e:
            # ูู ุญุตู ุฃู ูุดููุฉ ูุทุจุนูุง ููุฑุฌุน ูุงุฆูุฉ ูุงุถูุฉ
            print(f"ุฎุทุฃ ูู ุฌูุจ ุฅูุฌุงุฒุงุช ุงููุงุนุจ: {e}")
            return []

    def get_player_progress(self, player_id: int) -> Dict[str, Any]:
        """
        ุงูุฏุงูุฉ ุฏู ุจุชุฌูุจ ูุนูููุงุช ุนู ุชูุฏู ุงููุงุนุจ ูู ุงููุนุจุฉ ูุจุชุญูู ุฃุฏุงุกู.
        ุจุชุฌูุจ ูุนูููุงุช ุฒู:
        - ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจูุง ูู ูู ููู
        - ุนุฏุฏ ุงููุฑุงุช ุงููู ูุณุจ ูููุง 
        - ูุณุจุฉ ุฏูุฉ ุงูุชุตููุจ
        - ุฅุฌูุงูู ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจูุง
        - ุฅุฌูุงูู ุนุฏุฏ ูุฑุงุช ุงูููุฒ

        ุงููุฏุฎูุงุช:
            player_id: ุฑูู ุงููุงุนุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

        ุงููุฎุฑุฌุงุช:
            ูุงููุณ ููู ูู ุงููุนูููุงุช ุฏูุ ููู ุญุตู ูุดููุฉ ุจูุฑุฌุน ูุงููุณ ูุงุถู
        """
        try:
            # ูุฌูุจ ูุนูููุงุช ุงููุนุจ ุจุชุงุนุช ุงููุงุนุจ ุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            # ููุฌูุน ุงููุนูููุงุช ุฏู ุญุณุจ ูู ููู ูุนุจ ููู
            cursor = self.conn.execute('''
                WITH GameProgress AS (
                    SELECT 
                        DATE(played_at) as game_date,
                        COUNT(*) as games_played,
                        SUM(CASE WHEN result = 'win' THEN 1 ELSE 0 END) as wins,
                        AVG(accuracy) as daily_accuracy
                    FROM game_history
                    WHERE player_id = ?
                    GROUP BY DATE(played_at)
                    ORDER BY game_date
                )
                SELECT 
                    game_date,
                    games_played, 
                    wins,
                    daily_accuracy,
                    SUM(games_played) OVER (ORDER BY game_date) as total_games,
                    SUM(wins) OVER (ORDER BY game_date) as total_wins
                FROM GameProgress
            ''', (player_id,))
            
            # ูุฎุฒู ุงููุนูููุงุช ูู ูุงุฆูุฉ
            progress_data = []
            
            # ููุดู ุนูู ูู ุตู ูู ุงููุชูุฌุฉ ููุญุท ุงููุนูููุงุช ูู ุงููุงุฆูุฉ
            for row in cursor.fetchall():
                progress_data.append({
                    'date': row[0],             # ุงูุชุงุฑูุฎ
                    'games_played': row[1],      # ุนุฏุฏ ุงููุฑุงุช ุงููู ูุนุจูุง
                    'wins': row[2],             # ุนุฏุฏ ูุฑุงุช ุงูููุฒ
                    'accuracy': row[3],         # ูุณุจุฉ ุงูุฏูุฉ
                    'total_games': row[4],      # ุฅุฌูุงูู ุนุฏุฏ ุงููุนุจ
                    'total_wins': row[5]        # ุฅุฌูุงูู ุนุฏุฏ ุงูููุฒ
                })
            
            # ูุฑุฌุน ุงููุงููุณ ุงูููุงุฆู
            return {
                'daily_progress': progress_data,  # ูุนูููุงุช ุงูุชูุฏู ุงููููู
                'improvement_rate': self._calculate_improvement_rate(progress_data)  # ูุณุจุฉ ุงูุชุญุณู
            }
            
        except Exception as e:
            # ูู ุญุตู ุฃู ูุดููุฉ ูุทุจุน ุงูุฎุทุฃ ููุฑุฌุน ูุงููุณ ูุงุถู
            print(f"ุฎุทุฃ ูู ุฌูุจ ุชูุฏู ุงููุงุนุจ: {e}")
            return {}

    def _calculate_improvement_rate(self, progress_data: List[Dict]) -> float:
        """
        ุจุชุญุณุจ ูุณุจุฉ ุชุญุณู ุงููุงุนุจ ุนู ุทุฑูู ููุงุฑูุฉ ูุชุงูุฌู ูู ุฃูู 10 ุฃูุนุงุจ ูุน ุขุฎุฑ 10 ุฃูุนุงุจ

        Args:
            progress_data: ูุงุฆูุฉ ูููุง ูุนูููุงุช ุนู ูู ููู ูุนุจ ููู ุงููุงุนุจ

        Returns:
            ุฑูู ุจููุซู ูุณุจุฉ ุงูุชุญุณู
        """
        # ูู ุงููุงุนุจ ูุนูุฏูุด ุนูู ุงูุฃูู ูุนุจุชููุ ูุจูู ูููุฏุฑุด ูุญุณุจ ุงูุชุญุณู
        if len(progress_data) < 2:
            return 0.0
        
        try:
            # ููุงุฎุฏ ุฃูู 10 ุฃูุนุงุจ
            early_games = progress_data[:10]
            
            # ููุนุฏ ูุงู ูุฑุฉ ูุณุจ ูู ุฃูู 10 ุฃูุนุงุจ
            early_total_wins = 0
            early_total_games = 0
            for game in early_games:
                early_total_wins = early_total_wins + game['wins']
                early_total_games = early_total_games + game['games_played']
            
            # ูุญุณุจ ูุณุจุฉ ุงูููุฒ ูู ุฃูู 10 ุฃูุนุงุจ
            early_win_rate = early_total_wins / early_total_games
            
            # ููุงุฎุฏ ุขุฎุฑ 10 ุฃูุนุงุจ
            recent_games = progress_data[-10:]
            
            # ููุนุฏ ูุงู ูุฑุฉ ูุณุจ ูู ุขุฎุฑ 10 ุฃูุนุงุจ
            recent_total_wins = 0
            recent_total_games = 0
            for game in recent_games:
                recent_total_wins = recent_total_wins + game['wins']
                recent_total_games = recent_total_games + game['games_played']
            
            # ูุญุณุจ ูุณุจุฉ ุงูููุฒ ูู ุขุฎุฑ 10 ุฃูุนุงุจ
            recent_win_rate = recent_total_wins / recent_total_games
            
            # ูุญุณุจ ุงููุฑู ุจูู ุงููุณุจุชูู ููุญููู ููุณุจุฉ ูุฆููุฉ
            improvement = ((recent_win_rate - early_win_rate) / early_win_rate) * 100
            
            # ููุฑุจ ุงูุฑูู ูุฎุงูุชูู ุนุดุฑูุฉ
            return round(improvement, 2)
            
        except ZeroDivisionError:
            # ูู ุญุตู ูุณูุฉ ุนูู ุตูุฑ ูุฑุฌุน ุตูุฑ
            return 0.0
